$(function()
{
  // Enter submits messages, shift-enter does a new line in the chat message
  if ($('.messages').length > 0)
  {
    // combineUserMessages();
    $("textarea").keypress(function(e)
    {
      if (e.keyCode == 13 && !e.shiftKey)
      {
        e.preventDefault();
        $(this).parent('form').submit();
        return;
      }
    });
  }
});

// Consolidate message content into one message if multiple messages from one user
function combineUserMessages()
{
  $firstMessage = $(".message:first-child");

  $('.message').each(function()
  {
    $this = $(this);

    if ($this.attr('data-user') === $firstMessage.attr('data-user') && $this.attr('data-time') !== $firstMessage.attr('data-time'))
    {
      $firstMessage.find(".content").append("<br />" + $this.find(".content").html());
      $firstMessage.find(".content").attr('data-count', parseInt($firstMessage.find(".content").attr('data-count')) + parseInt($this.find(".content").attr('data-count')));
      $firstMessage.attr('data-oldest-time', $this.attr('data-oldest-time'));
      $this.remove();
    }
    else
    {
      $firstMessage = $this;
    }
  });
}

function fadeInNewMessages()
{
  // fade in new messages
  $('.new-message').each(function()
  {
    $(this).fadeIn();
  });
}

function temporarySpamBlock()
{
  // Disable the ability to post a new message for a second
  $postMessage = $('.post-message');
  if ($postMessage.attr("disabled"))
  {
    $postMessage.removeAttr("disabled");
  }
  else
  {
    $postMessage.attr("disabled", "disabled");
    setTimeout(temporarySpamBlock, <%= Figaro.env.chat_limit.to_i %>);
  }
}
